{% extends "base.html" %}

{% block title %}Admin ‚Äì {{ package_id }} | winget REST Repository{% endblock %}

{% block content %}
  <section>
  <div>
    <a href="/admin/packages" class="button-back" title="Back to packages">‚Üê</a>
  </div>

  <div class="package-layout">
    <section id="package-details">
      <h3>
        Package: <code>{{ package_id }}</code>
        <button onclick="openPackageModal('{{ package_id }}')" class="button-small button-add-regular" title="Edit package">Edit</button>
        <button onclick="confirmDeletePackage('{{ package_id }}')" class="button-delete" title="Delete package">üóëÔ∏è</button>
      </h3>
      <dl class="details-list">
        <dt>Name</dt>
        <dd>{{ package.package_name if package else '-' }}</dd>
        
        <dt>Publisher</dt>
        <dd>{{ package.publisher if package else '-' }}</dd>
        
        <dt>Description</dt>
        <dd>{{ package.short_description if package and package.short_description else '-' }}</dd>
        
        <dt>License</dt>
        <dd>{{ package.license if package and package.license else '-' }}</dd>
        
        <dt>Tags</dt>
        <dd>
          {% if package and package.tags %}
            {% for tag in package.tags %}
              <span class="tag">{{ tag }}</span>{% if not loop.last %}, {% endif %}
            {% endfor %}
          {% else %}
            -
          {% endif %}
        </dd>
      </dl>
    </section>

    <section id="versions-section">
      <h3>
        Versions
        <button onclick="openVersionModal('{{ package_id }}', 'new')" class="button-add" title="Add new version">+</button>
      </h3>

      <table class="table">
        <thead>
          <tr>
            <th>Version</th>
            <th>Architecture</th>
            <th>Scope</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for v in versions %}
          <tr onclick="openVersionModal('{{ package_id }}', '{{ v.version }}-{{ v.architecture }}-{{ v.scope }}')">
            <td>{{ v.version }}</td>
            <td>{{ v.architecture }}</td>
            <td>{{ v.scope }}</td>
            <td onclick="event.stopPropagation();">
              <button onclick="openVersionModalClone('{{ package_id }}', '{{ v.version }}-{{ v.architecture }}-{{ v.scope }}')" class="button-small">Upload new version</button>
              <button onclick="deleteVersion('{{ package_id }}', '{{ v.version }}-{{ v.architecture }}-{{ v.scope }}')" class="button-small button-danger">Delete</button>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="4">No versions found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  </div>
</section>

{% include "modal.html" %}

<script>
function openPackageModal(packageId) {
  const encodedPackageId = encodeURIComponent(packageId);
  openModal(
    'Edit Package',
    `/admin/packages/${encodedPackageId}/fragment`,
    `/admin/packages/${encodedPackageId}`,
    'reload'
  );
}

function openVersionModal(packageId, versionId) {
  const encodedVersionId = encodeURIComponent(versionId);
  const title = versionId === 'new' ? 'New Version' : 'Edit Version';
  openModal(
    title,
    `/admin/packages/${packageId}/versions/${encodedVersionId}/fragment`,
    `/admin/packages/${packageId}/versions/${encodedVersionId}`,
    'reload'
  );
}

function openVersionModalClone(packageId, sourceVersionId) {
  const encodedSourceVersionId = encodeURIComponent(sourceVersionId);
  openModal(
    'Upload New Version',
    `/admin/packages/${packageId}/versions/new/fragment?clone_from=${encodedSourceVersionId}`,
    `/admin/packages/${packageId}/versions/new`,
    'reload'
  );
}

async function deleteVersion(packageId, versionId) {
  if (!confirm(`Delete version ${versionId}? This cannot be undone.`)) {
    return;
  }
  
  try {
    const encodedVersionId = encodeURIComponent(versionId);
    const res = await fetch(`/admin/packages/${packageId}/versions/${encodedVersionId}/delete`, {
      method: 'POST',
    });
    
    const data = await res.json();
    
    if (res.ok && data.success) {
      window.location.reload();
    } else {
      alert(data.error || 'Failed to delete version');
    }
  } catch (error) {
    alert(`Error: ${error.message}`);
  }
}

function confirmDeletePackage(packageId) {
  if (!confirm(`Delete package ${packageId} and all its versions? This cannot be undone.`)) {
    return;
  }
  
  fetch(`/admin/packages/${encodeURIComponent(packageId)}/delete`, {
    method: 'POST',
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        window.location.href = '/admin/packages';
      } else {
        alert(data.error || 'Failed to delete package');
      }
    })
    .catch(error => {
      alert(`Error: ${error.message}`);
    });
}
</script>
{% endblock %}
