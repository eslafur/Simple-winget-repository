{% include "modal_form_helpers.html" %}

<form
  method="post"
  class="form"
  enctype="multipart/form-data"
  data-package-id="{{ package_id }}"
  data-version-id="{{ version_id }}"
  data-version-form="true"
  data-submit-endpoint="{% if version_id != 'new' %}/admin/packages/{{ package_id }}/versions/{{ version_id }}{% else %}/admin/packages/{{ package_id }}/versions/new{% endif %}"
  action="#"
>
  <div class="modal-form-group">
    <label for="version">Version <span class="required">*</span></label>
    <input
      id="version"
      name="version"
      type="text"
      value="{{ version_meta.version if version_meta else '' }}"
      required
    />
  </div>

  <div class="modal-form-group">
    <label for="product_code">Product code <span class="required">*</span></label>
    <input
      id="product_code"
      name="product_code"
      type="text"
      value="{{ version_meta.product_code if version_meta and version_meta.product_code else '' }}"
      required
    />
  </div>

  <div class="modal-form-group">
    <label for="architecture">Architecture</label>
    <select id="architecture" name="architecture" required>
      {% for opt in architecture_options %}
      <option value="{{ opt }}" {% if version_meta and version_meta.architecture == opt %}selected{% endif %}>
        {{ opt }}
      </option>
      {% endfor %}
    </select>
  </div>

  <div class="modal-form-group">
    <label for="scope">Scope</label>
    <select id="scope" name="scope" required>
      {% for opt in scope_options %}
      <option value="{{ opt }}" {% if version_meta and version_meta.scope == opt %}selected{% endif %}>
        {{ opt }}
      </option>
      {% endfor %}
    </select>
  </div>

  <div class="modal-form-group">
    <label for="installer_type">Installer type</label>
    <select id="installer_type" name="installer_type">
      {% for opt in installer_type_options %}
      <option value="{{ opt }}" {% if (version_meta and version_meta.installer_type == opt) or (not version_meta and opt == 'exe') %}selected{% endif %}>
        {{ opt }}
      </option>
      {% endfor %}
    </select>
  </div>

  <div id="nested-installers-section" class="form-section">
    <div class="modal-form-group">
      <label for="nested_installer_type">Nested installer type <span class="required">*</span></label>
      <select id="nested_installer_type" name="nested_installer_type">
        <option value="">(None)</option>
        {% for opt in nested_installer_type_options %}
        <option
          value="{{ opt }}"
          {% if version_meta and version_meta.nested_installer_type == opt %}selected{% endif %}
        >
          {{ opt }}
        </option>
        {% endfor %}
      </select>
      <small>Used when the installer is an archive (zip) that contains another installer.</small>
    </div>

    <div class="modal-form-group" id="nested-single-row">
      <label for="nested_single_relative_file_path">Nested installer path in archive <span class="required">*</span></label>
      <input
        id="nested_single_relative_file_path"
        name="nested_relative_file_path"
        type="text"
        value="{% if version_meta and version_meta.nested_installer_type and version_meta.nested_installer_type != 'portable' and version_meta.nested_installer_files %}{{ version_meta.nested_installer_files[0].relative_file_path }}{% else %}{% endif %}"
      />
      <small>Relative path to the nested installer file inside the archive.</small>
    </div>

    <div class="modal-form-group" id="nested-portable-table-container">
      <label>Nested portable files</label>
      <table class="table table-compact" id="nested-portable-table">
        <thead>
          <tr>
            <th>Relative file path</th>
            <th>Portable command alias (optional)</th>
          </tr>
        </thead>
        <tbody id="nested-portable-tbody">
          {% if version_meta and version_meta.nested_installer_type == 'portable' and version_meta.nested_installer_files %}
            {% for f in version_meta.nested_installer_files %}
            <tr>
              <td>
                <input
                  type="text"
                  name="nested_relative_file_path"
                  value="{{ f.relative_file_path }}"
                />
              </td>
              <td>
                <input
                  type="text"
                  name="nested_portable_command_alias"
                  value="{{ f.portable_command_alias or '' }}"
                />
              </td>
            </tr>
            {% endfor %}
          {% endif %}
          <tr>
            <td>
              <input
                type="text"
                name="nested_relative_file_path"
                value=""
              />
            </td>
            <td>
              <input
                type="text"
                name="nested_portable_command_alias"
                value=""
              />
            </td>
          </tr>
        </tbody>
      </table>
      <small>When NestedInstallerType is portable, list each portable binary inside the archive and optionally the command alias that WinGet should expose.</small>
    </div>
  </div>

  <div class="modal-form-group">
    <label for="upload">Installer file{% if not version_meta %} <span class="required">*</span>{% endif %}</label>
    {% if version_meta and version_meta.installer_file %}
    <small>Current: <code>{{ version_meta.installer_file }}</code></small>
    {% endif %}
    <input id="upload" name="upload" type="file" {% if not version_meta %}required{% endif %} />
    <small>
      {% if version_meta %}
      Upload a new installer to replace the existing one.
      {% else %}
      Uploading a setup file is mandatory for a new version.
      {% endif %}
    </small>
  </div>

  <div id="custom-installer-section" class="form-section">
    <div class="modal-form-group">
      <label>Custom installer steps</label>
      <table class="table table-compact" id="custom-installer-steps">
        <thead>
          <tr>
            <th>Action</th>
            <th colspan="10">Arguments</th>
          </tr>
        </thead>
        <tbody id="custom-steps-tbody">
          {% if version_meta and version_meta.custom_installer_steps %}
            {% for step in version_meta.custom_installer_steps %}
            {% set step_args = step.arguments if step.arguments else {} %}
            <tr data-step-index="{{ loop.index0 }}">
              <td>
                <select name="custom_action_type" class="custom-action-select">
                  <option value="">(Select action)</option>
                  {% for action in custom_actions %}
                  <option
                    value="{{ action.id }}"
                    {% if step.action_type == action.id %}selected{% endif %}
                  >
                    {{ action.label }}
                  </option>
                  {% endfor %}
                </select>
              </td>
              <td class="custom-args-container">
                {% for action in custom_actions %}
                  {% if step.action_type == action.id and action.arguments %}
                    {% for arg_def in action.arguments %}
                      {% if arg_def.visible != false %}
                      {% set arg_value = '' %}
                      {% if arg_def.name in step_args %}
                        {% set arg_value = step_args[arg_def.name] %}
                      {% endif %}
                      <div class="custom-arg-field" data-arg-name="{{ arg_def.name }}" style="display: block;">
                        <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">
                          {{ arg_def.label or arg_def.name }}
                          {% if arg_def.required %}<span class="required">*</span>{% endif %}
                        </label>
                        <input
                          type="text"
                          class="custom-arg-input"
                          data-arg-name="{{ arg_def.name }}"
                          placeholder="{{ arg_def.placeholder or '' }}"
                          title="{{ arg_def.description or '' }}"
                          value="{{ arg_value }}"
                          {% if arg_def.required %}data-required="true"{% endif %}
                        />
                      </div>
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                {% endfor %}
                <input type="hidden" name="custom_args_json" class="custom-args-json" value="{{ step_args | tojson }}" />
              </td>
            </tr>
            {% endfor %}
          {% endif %}
          <tr data-step-index="new">
            <td>
              <select name="custom_action_type" class="custom-action-select">
                <option value="">(Select action)</option>
                {% for action in custom_actions %}
                <option value="{{ action.id }}">{{ action.label }}</option>
                {% endfor %}
              </select>
            </td>
            <td class="custom-args-container">
              <input type="hidden" name="custom_args_json" class="custom-args-json" value="" />
            </td>
          </tr>
        </tbody>
      </table>
      <small>The server will generate an <code>install.bat</code> from these steps and package it together with the uploaded installer into a ZIP that WinGet downloads.</small>
    </div>
  </div>
  <script type="application/json" data-custom-actions>
    {{ custom_actions | tojson }}
  </script>

  <div class="modal-form-group">
    <label for="silent_arguments">
      <input
        type="checkbox"
        name="install_mode_silent"
        value="true"
        {% if version_meta %}
          {% if version_meta.install_mode_silent %}checked{% endif %}
        {% else %}
          checked
        {% endif %}
      />
      Silent arguments
    </label>
    <input
      id="silent_arguments"
      name="silent_arguments"
      type="text"
      value="{{ version_meta.silent_arguments if version_meta and version_meta.silent_arguments else '' }}"
    />
  </div>

  <div class="modal-form-group">
    <label for="silent_with_progress_arguments">
      <input
        type="checkbox"
        name="install_mode_silent_with_progress"
        value="true"
        {% if version_meta %}
          {% if version_meta.install_mode_silent_with_progress %}checked{% endif %}
        {% else %}
          checked
        {% endif %}
      />
      Silent with progress
    </label>
    <input
      id="silent_with_progress_arguments"
      name="silent_with_progress_arguments"
      type="text"
      value="{{ version_meta.silent_with_progress_arguments if version_meta and version_meta.silent_with_progress_arguments else '' }}"
    />
  </div>

  <div class="modal-form-group">
    <label for="interactive_arguments">
      <input
        type="checkbox"
        name="install_mode_interactive"
        value="true"
        {% if version_meta %}
          {% if version_meta.install_mode_interactive %}checked{% endif %}
        {% else %}
          checked
        {% endif %}
      />
      Interactive arguments
    </label>
    <input
      id="interactive_arguments"
      name="interactive_arguments"
      type="text"
      value="{{ version_meta.interactive_arguments if version_meta and version_meta.interactive_arguments else '' }}"
    />
  </div>

  <div class="modal-form-group">
    <label for="log_arguments">Log arguments</label>
    <input
      id="log_arguments"
      name="log_arguments"
      type="text"
      value="{{ version_meta.log_arguments if version_meta and version_meta.log_arguments else '' }}"
    />
  </div>

  <div class="modal-form-group">
    <label>
      <input
        type="checkbox"
        id="requires_elevation"
        name="requires_elevation"
        value="true"
        {% if version_meta and version_meta.requires_elevation %}checked{% endif %}
      />
      Requires elevation (run as administrator)
    </label>
  </div>

  <div class="modal-form-group">
    <label for="package_dependencies">Package dependencies</label>
    <input
      id="package_dependencies_filter"
      type="text"
      placeholder="Filter packages..."
    />
    <div class="modal-multiselect-group" data-multi-select="package_dependencies">
      {% for pid in all_package_ids %}
      <label class="modal-checkbox-label">
        <input
          type="checkbox"
          value="{{ pid }}"
          {% if version_meta and version_meta.package_dependencies and pid in version_meta.package_dependencies %}checked{% endif %}
        >
        {{ pid }}
      </label>
      {% endfor %}
    </div>
    <small>Select zero or more packages that this version depends on.</small>
  </div>

</form>